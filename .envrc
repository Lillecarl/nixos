#! /usr/bin/env bash

# We need $FLAKE for our impurity
export FLAKE=$PWD
# Save $FLAKE to a file
echo "\"$FLAKE\"" > "$FLAKE/.flakepath"

cmd="nix"

if has systemd-run
then
  cmd="systemd-run --user --unit repofarm $cmd"
fi

# Cache PATH from nix develop for one hour
if ! has fd || ! fd --type l --no-ignore --max-depth 1 --hidden --quiet --changed-within 1h .nix
then
  echo "Building repo tool collection..."
  $cmd build "$FLAKE#repofarm" --out-link "$FLAKE/.nix" --json &> /dev/null || true
  #nix build .#repofarm --out-link .nix
else
  echo "Using cached repo tool collection :)"
fi

PATH_add "$FLAKE/.nix/bin"
PATH_add "$FLAKE/bin"
